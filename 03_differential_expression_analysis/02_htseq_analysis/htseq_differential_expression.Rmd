--- 
title: "Salmo sex study"
output: htseq_differential_expression.html
author: Joe Colgan (joscolgan)
--- 

## Introduction  
This scripts takes in the output quantification files generated by [HTSeq](https://htseq.readthedocs.io/en/release_0.11.1/count.html) and performs differential expression analysis using [DESeq2](https://bioconductor.org/packages/release/bioc/html/DESeq2.html).  
This script outputs:  
1) A text file containing dataframe consisting of significant genes.  
2) An R object of a PCA based on r-log transformed gene-level counts.  

1. Load libraries:

```{r, message = FALSE}
# Load libraries; install from scratch if needed
libraries <- c("tximport",
               "DESeq2",
               "ggplot2")
for (lib in libraries) {
    if (require(package = lib, character.only = TRUE)) {
        print("Successful")
    } else {
        print("Installing")
        source("https://bioconductor.org/biocLite.R")
        library(lib, character.only = TRUE)
    }
}
## Create output directory:
dir.create("results")
```

2. Read in hisat2-htseq counts:

```{r, message=FALSE}
## Set directory:
directory <- "input/"

samples_information <- read.table(file = "data/sample_information_liver.txt",
                                  header = FALSE,
                                  col.names = c("sample_name",
                                                "sex",
                                                "batch",
                                                "family",
                                                "pop",
                                                "group"),
                                  row.names = 1)

## Create a list of samples:
sample_files <- grep(".txt",
                    list.files(directory),
                    value = TRUE)

samples_information$sample_name <- sample_files
samples_information$file_name <- sample_files
samples_information <- samples_information[, c(6, 7, 1:5)]

## Build DESeq2 dataset:
dds_htseq <- DESeqDataSetFromHTSeqCount(sampleTable = samples_information,
                                       directory = directory,
                                       design = ~ batch + family + sex)

keep <- rowSums(counts(dds_htseq)) >= 10
dds_htseq <- dds_htseq[keep, ]

# Run DESeq2 (Wald test) for differential expression analysis:
## Which genes are differentially expressed within each treatment for
## each caste in comparison to control?
## Perform a pairwise comparison between treatments:
deseq_object  <- DESeq(dds_htseq,
                       test = "Wald",
                       betaPrior = TRUE)

deseq_results <- results(deseq_object,
                         contrast = c("sex",
                                      "F",
                                      "M"))

## Convert into a dataframe:
deseq_results_df <- as.data.frame(deseq_results)
print(nrow(deseq_results_df))
# Results table ordered by smallest p value:
deseq_results_df_reordered <- deseq_results_df[order(deseq_results_df$pvalue), ]

# Subset significant genes:
deseq_results_df_reordered_sig <- subset(deseq_results_df_reordered,
                                                         padj <= 0.05)
print(nrow(deseq_results_df_reordered_sig))
```

3. Output text files:

```{r, message = FALSE}
output <- "./results/01_differentially_expressed/"
dir.create(output,
           recursive = TRUE)

# Save object for use in other scripts
dds_htseq_counts <- counts(dds_htseq)
save(dds_htseq_counts, file = paste(output,
                             "txi_count_estimates.RData",
                             sep = ""))

write.table(dds_htseq_counts, file = paste(output,
                             "txi_count_estimates.txt",
                             sep = ""),
                             row.names = TRUE,
                             col.names = TRUE,
                             quote = FALSE,
                             sep = "\t")

# Save to output:
write.table(x = deseq_results_df_reordered,
            file = paste(output,
                         "differentially_expressed_genes_raw.txt",
                         sep = ""),
            sep = "\t",
            quote = FALSE)

# Save to output:
write.table(x = deseq_results_df_reordered_sig,
            file = paste(output,
                         "differentially_expressed_genes_sig.txt",
                         sep = ""),
            sep = "\t",
            quote = FALSE)
```

4. Save everything as an R object:

```{r, message = FALSE}
save.image(file = "results/htseq_analysis.RData")
```

5. Run lintr:

```{r, message = FALSE}
lintr::lint(file = "results/htseq_differential_expression.Rmd")
```
